{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import {\n  useCallback,\n  useLayoutEffect,\n  useEffect,\n  useReducer,\n  useRef,\n} from 'react';\nimport {\n  Accessor,\n  Client,\n  accessorInterceptors,\n} from 'gqless';\n\nconst isSSR = (\n  typeof window === 'undefined'\n  || /ServerSideRendering/.test(window.navigator && window.navigator.userAgent)\n);\n\nconst useIsomorphicLayoutEffect = isSSR ? (cb: () => void) => cb() : useLayoutEffect;\n\n/**\n * useQuery\n *\n * This hook returns query from gqless.\n *\n * @example\n * import { useQuery } from 'gqless-hook';\n * import { client } from '../graphql'; // generated by @gqless/cli\n *\n * const Component = () => {\n *   const query = useQuery(client);\n *   return (\n *     <div>{query.foo}</div>\n *   );\n * };\n */\nexport const useQuery = <Data>(client: Client<Data>): Data => {\n  const [, forceUpdate] = useReducer((c) => c + 1, 0);\n  const fetching = useRef(false);\n  if (fetching.current) {\n    throw new Promise((resolve) => {\n      client.scheduler.commit.onFetched.then(resolve);\n    });\n  }\n\n  const onActive = useCallback(() => {\n    fetching.current = true;\n  }, []);\n  const onFetched = useCallback(() => {\n    fetching.current = false;\n  }, []);\n  client.scheduler.commit.onActive.then(onActive);\n  client.scheduler.commit.onFetched.then(onFetched);\n  useIsomorphicLayoutEffect(() => {\n    if (fetching.current) {\n      forceUpdate();\n    } else if (client.scheduler.commit.accessors.size > 0) {\n      fetching.current = true;\n      forceUpdate();\n    }\n  });\n\n  const updateUnlessFetching = useCallback(() => {\n    if (!fetching.current) {\n      forceUpdate();\n    }\n  }, []);\n  const onAccessor = useCallback((accessor: Accessor) => {\n    accessor.onDataChange.then(updateUnlessFetching);\n  }, [updateUnlessFetching]);\n  accessorInterceptors.add(onAccessor);\n  const timer = setTimeout(() => {\n    accessorInterceptors.delete(onAccessor);\n  }, 5 * 1000);\n  useEffect(() => {\n    clearTimeout(timer);\n    accessorInterceptors.delete(onAccessor);\n  });\n\n  return client.query;\n};\n"],"names":["useIsomorphicLayoutEffect","window","test","navigator","userAgent","cb","useLayoutEffect","client","forceUpdate","useReducer","c","fetching","useRef","current","Promise","resolve","scheduler","commit","onFetched","then","onActive","useCallback","accessors","size","updateUnlessFetching","onAccessor","accessor","onDataChange","accessorInterceptors","add","timer","setTimeout","useEffect","clearTimeout","query"],"mappings":"2CAkBMA,EAJc,oBAAXC,QACJ,sBAAsBC,KAAKD,OAAOE,WAAaF,OAAOE,UAAUC,WAG3B,SAACC,UAAmBA,KAAOC,mCAkB7C,SAAOC,OACpBC,EAAeC,aAAW,SAACC,UAAMA,EAAI,GAAG,MAC3CC,EAAWC,UAAO,GACxB,GAAID,EAASE,QACX,UAAUC,QAAQ,SAACC,GACjBR,EAAOS,UAAUC,OAAOC,UAAUC,KAAKJ,KAI3C,IAAMK,EAAWC,cAAY,WAC3BV,EAASE,SAAU,GAClB,IACGK,EAAYG,cAAY,WAC5BV,EAASE,SAAU,GAClB,IACHN,EAAOS,UAAUC,OAAOG,SAASD,KAAKC,GACtCb,EAAOS,UAAUC,OAAOC,UAAUC,KAAKD,GACvClB,EAA0B,WACpBW,EAASE,QACXL,IACSD,EAAOS,UAAUC,OAAOK,UAAUC,KAAO,IAClDZ,EAASE,SAAU,EACnBL,OAIJ,IAAMgB,EAAuBH,cAAY,WAClCV,EAASE,SACZL,KAED,IACGiB,EAAaJ,cAAY,SAACK,GAC9BA,EAASC,aAAaR,KAAKK,IAC1B,CAACA,IACJI,uBAAqBC,IAAIJ,GACzB,IAAMK,EAAQC,WAAW,WACvBH,8BAA4BH,IAC3B,KAMH,OALAO,YAAU,WACRC,aAAaH,GACbF,8BAA4BH,KAGvBlB,EAAO2B"}